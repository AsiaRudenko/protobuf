using BenchmarkDotNet.Attributes;
using System;
using System.Collections.Generic;
using System.IO;
using System.Text;
using GenRequest = Provided.Namespace2.SearchRequest;

namespace Zenserdes.Protobuf.Benchmarks
{
	/// <summary>
	/// Added a hotpath for Memory & Span, yielding an improvement over the last iteration.
	/// <para>
	/// |    Method | LongRetention |      Mean |    Error |   StdDev |
	/// |---------- |-------------- |----------:|---------:|---------:|
	/// | TryMemory |         False |  54.72 ns | 0.454 ns | 0.424 ns |
	/// |   TrySpan |         False | 102.73 ns | 0.825 ns | 0.772 ns |
	/// | TryStream |         False | 361.50 ns | 3.882 ns | 3.631 ns |
	/// |    Memory |         False |  56.72 ns | 0.561 ns | 0.525 ns |
	/// |      Span |         False | 103.12 ns | 0.929 ns | 0.869 ns |
	/// |    Stream |         False | 364.05 ns | 3.094 ns | 2.894 ns |
	/// | TryMemory |          True |  70.14 ns | 0.667 ns | 0.624 ns |
	/// |   TrySpan |          True | 114.93 ns | 1.143 ns | 1.070 ns |
	/// | TryStream |          True | 377.96 ns | 2.770 ns | 2.591 ns |
	/// |    Memory |          True |  81.21 ns | 0.770 ns | 0.720 ns |
	/// |      Span |          True | 111.27 ns | 1.066 ns | 0.997 ns |
	/// |    Stream |          True | 378.25 ns | 3.823 ns | 3.576 ns |
	/// </para>
	/// </summary>
	public class AutoGeneratedCode2VarintPatchBenchmarks
	{
		private static ReadOnlyMemory<byte> _payload = new ReadOnlyMemory<byte>(PseudoMessageBenchmarks.Payload);

		[Params(true, false)]
		public bool LongRetention { get; set; }

		[Benchmark]
		public GenRequest TryMemory()
		{
			var success = ZenserdesProtobuf.TryDeserialize<GenRequest>(_payload, out var result, LongRetention);
			return result;
		}

		[Benchmark]
		public GenRequest TrySpan()
		{
			var success = ZenserdesProtobuf.TryDeserialize<GenRequest>(_payload.Span, out var result, LongRetention);
			return result;
		}

		[Benchmark]
		public GenRequest TryStream()
		{
			using (var memoryStream = new MemoryStream(PseudoMessageBenchmarks.Payload))
			{
				var success = ZenserdesProtobuf.TryDeserialize<GenRequest>(memoryStream, out var result, LongRetention);
				return result;
			}
		}

		[Benchmark]
		public GenRequest Memory()
		{
			return ZenserdesProtobuf.Deserialize<GenRequest>(_payload, LongRetention);
		}

		[Benchmark]
		public GenRequest Span()
		{
			return ZenserdesProtobuf.Deserialize<GenRequest>(_payload.Span, LongRetention);
		}

		[Benchmark]
		public GenRequest Stream()
		{
			using (var memoryStream = new MemoryStream(PseudoMessageBenchmarks.Payload))
			{
				return ZenserdesProtobuf.Deserialize<GenRequest>(memoryStream, LongRetention);
			}
		}
	}
}

/*
syntax = "proto3";
option csharp_namespace = "SomeName.Space";

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
}
 */

// <auto-generated>
// This code was generated with Zenserdes.Protobuf.ZGen
// The code generated here will only work with Zenserdes.Protobuf 1.*.*
// See the Zenserdes.Protobuf project on github: https://github.com/Zenserdes/protobuf/tree/master/csharp
// </auto-generated>

namespace Provided.Namespace2
{
	public partial struct SearchRequest : global::Zenserdes.Protobuf.IMessageAndOperator<global::Provided.Namespace2.SearchRequest>
	{
		/// <summary>
		/// Index: 1
		/// </summary>
		public global::System.ReadOnlyMemory<byte> Query { get; set; }

		/// <summary>
		/// Index: 2
		/// </summary>
		public int PageNumber { get; set; }

		/// <summary>
		/// Index: 3
		/// </summary>
		public int ResultPerPage { get; set; }

		public int SizeHint => 256; // TODO: calculate a good size hint

		bool global::Zenserdes.Protobuf.IMessage.Serialize(global::Zenserdes.Protobuf.Serialization.SpanScriber target)
		{
			throw new global::System.NotImplementedException();
		}

		bool global::Zenserdes.Protobuf.IMessage.Serialize(global::Zenserdes.Protobuf.Serialization.MemoryScriber target)
		{
			throw new global::System.NotImplementedException();
		}

		void global::Zenserdes.Protobuf.IMessage.Serialize(global::Zenserdes.Protobuf.Serialization.StreamScriber target)
		{
			throw new global::System.NotImplementedException();
		}

		ulong global::Zenserdes.Protobuf.IMessageOperator<global::Provided.Namespace2.SearchRequest>.ExactSize(in global::Provided.Namespace2.SearchRequest message)
		{
			throw new global::System.NotImplementedException();
		}

		ulong global::Zenserdes.Protobuf.IMessageOperator<global::Provided.Namespace2.SearchRequest>.ExactSize(global::Provided.Namespace2.SearchRequest message)
		{
			throw new global::System.NotImplementedException();
		}

		bool global::Zenserdes.Protobuf.IMessageOperator<global::Provided.Namespace2.SearchRequest>.TryDeserialize<TBufferWriter>(ref global::Zenserdes.Protobuf.Serialization.SpanDataStreamer<TBufferWriter> dataStreamer, ref global::Provided.Namespace2.SearchRequest instance)
		{
			byte wireByte = default;
			global::System.Span<byte> temp = stackalloc byte[10];

			while (dataStreamer.Next(ref wireByte))
			{
				switch (wireByte)
				{
					case 0b00001_010:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						if (!dataStreamer.ReadPermanent((int)result, out var memory))
						{
							return false;
						}

						instance.Query = memory;
					}
					break;

					case 0b00010_000:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						instance.PageNumber = (int)result;
					}
					break;

					case 0b00011_000:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						instance.ResultPerPage = (int)result;
					}
					break;
				}
			}

			return true;
		}

		bool global::Zenserdes.Protobuf.IMessageOperator<global::Provided.Namespace2.SearchRequest>.TryDeserialize<TBufferWriter>(ref global::Zenserdes.Protobuf.Serialization.MemoryDataStreamer<TBufferWriter> dataStreamer, ref global::Provided.Namespace2.SearchRequest instance)
		{
			byte wireByte = default;

			while (dataStreamer.Next(ref wireByte))
			{
				switch (wireByte)
				{
					case 0b00001_010:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						if (!dataStreamer.ReadPermanent((int)result, out var memory))
						{
							return false;
						}

						instance.Query = memory;
					}
					break;

					case 0b00010_000:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						instance.PageNumber = (int)result;
					}
					break;

					case 0b00011_000:
					{
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(dataStreamer.ReadOnlySpan, ref dataStreamer.Position, ref result))
						{
							return false;
						}

						instance.ResultPerPage = (int)result;
					}
					break;
				}
			}

			return true;
		}

		bool global::Zenserdes.Protobuf.IMessageOperator<global::Provided.Namespace2.SearchRequest>.TryDeserialize<TBufferWriter>(ref global::Zenserdes.Protobuf.Serialization.StreamDataStreamer<TBufferWriter> dataStreamer, ref global::Provided.Namespace2.SearchRequest instance)
		{
			byte wireByte = default;
			global::System.Span<byte> temp = stackalloc byte[10];

			while (dataStreamer.Next(ref wireByte))
			{
				switch (wireByte)
				{
					case 0b00001_010:
					{
						dataStreamer.MaybeReadWorkaround(10).CopyTo(temp);

						var offset = 0;
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(temp, ref offset, ref result))
						{
							return false;
						}

						dataStreamer.Advance(offset);
						if (!dataStreamer.ReadPermanent((int)result, out var memory))
						{
							return false;
						}

						instance.Query = memory;
					}
					break;

					case 0b00010_000:
					{
						dataStreamer.MaybeReadWorkaround(10).CopyTo(temp);

						var offset = 0;
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(temp, ref offset, ref result))
						{
							return false;
						}

						dataStreamer.Advance(offset);
						instance.PageNumber = (int)result;
					}
					break;

					case 0b00011_000:
					{
						dataStreamer.MaybeReadWorkaround(10).CopyTo(temp);

						var offset = 0;
						var result = 0u;
						if (!global::Zenserdes.Protobuf.Serialization.DataDecoder.TryReadVarint32(temp, ref offset, ref result))
						{
							return false;
						}

						dataStreamer.Advance(offset);
						instance.ResultPerPage = (int)result;
					}
					break;
				}
			}

			return true;
		}

	}
}
